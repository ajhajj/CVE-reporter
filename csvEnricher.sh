#!/bin/bash

INPUT_FILE=twistlock.csv
OUTPUT_FILE=output.csv
DEL=","
CVE_ID="CVE ID"
RESTURL=https://access.redhat.com/hydra/rest/securitydata/cve/
JSON_FLDR=JSON
CWD=$(pwd)

echo "${CWD}"

echo "Extracting CVE list from CSV..."
index=`awk -F "${DEL}" 'NR>1{exit}1{ for (i=1;i<=NF;i++) if ($i == "'"${CVE_ID}"'") print i }' ${INPUT_FILE}`
CVEARR=($(awk -v pos=${index} -F "${DEL}" 'NR>1{print $pos}' ${INPUT_FILE}))
UNQ_CVEARR=($(echo "${CVEARR[@]}" | tr ' ' '\n' | sort -u | tr '\n' ' '))

rm -rf ${JSON_FLDR}
mkdir ${JSON_FLDR}
cd ${JSON_FLDR}

echo "Retrieving Red Hat data on CVEs..."
for cve in "${UNQ_CVEARR[@]}"; 
  do
    wget -q -nc ${RESTURL}${cve}.json
  done

cd ${CWD}

echo "Updating CSV document..."
rm -f ${OUTPUT_FILE}
cp ${INPUT_FILE} ${OUTPUT_FILE}

sed -i -e 's/'"${CVE_ID}"'/'"${CVE_ID}"',RH_CSSV_SCORE,RH_CSSV_VECTOR,RH_CSSV_STATUS,RH_STATEMENT/' ${OUTPUT_FILE}
for cve in "${UNQ_CVEARR[@]}";  
  do
    cvss3=`cat ${JSON_FLDR}/${cve}.json | jq -r '.cvss3'`

    if [ "${cvss3}" == "null" ]; then
      cvss_base_score=`cat ${JSON_FLDR}/${cve}.json | jq -r '.cvss.cvss_base_score'`
      cvss_scoring_vector=`cat ${JSON_FLDR}/${cve}.json | jq -r '.cvss.cvss_scoring_vector'`
      status=`cat ${JSON_FLDR}/${cve}.json | jq -r '.cvss.status'`
    else
      cvss_base_score=`cat ${JSON_FLDR}/${cve}.json | jq -r '.cvss3.cvss3_base_score'`
      cvss_scoring_vector=`cat ${JSON_FLDR}/${cve}.json | jq -r '.cvss3.cvss3_scoring_vector'`
      status=`cat ${JSON_FLDR}/${cve}.json | jq -r '.cvss3.status'`
    fi

    statement=`cat ${JSON_FLDR}/${cve}.json | jq -r '.statement' | tr '\n' ' '`
    data=",${cvss_base_score},${cvss_scoring_vector},${status},\"${statement}\""
    sed -i -e 's|,'"${cve}"',|,'"${cve}${data}"',|' ${OUTPUT_FILE}

  done
